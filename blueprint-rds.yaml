tosca_definitions_version: cloudify_dsl_1_3

imports:
  - https://cloudify.co/spec/cloudify/5.1.2/types.yaml
  - plugin:cloudify-terraform-plugin?version= >=0.15.0

inputs:
  aws_region:
    type: string
    description: AWS region to launch servers
    required: true
    default: eu-central-1

  availability_zones:
    type: list
    description: AWS ELB availability zones
    required: true
    default: [ eu-central-1a, eu-central-1b ]

  elb_name:
    type: string
    description: Name of the Elastic Load Balancer to be created.
    required: true
    default: CloudifyELB

  db_name:
    type: string
    description: Name of the database to be created. Must begin with a letter and contain only alphanumeric characters.
    required: true
    default: CloudifyDB
    constraints:
      - pattern: "^[a-zA-Z][a-zA-Z0-9]+$"

  db_username:
    type: string
    description: Name of the database user
    required: true
    default: cloudify

  db_password:
    type: string
    description: Password of the database user
    required: true
    default: C!0ud1FY

  domain_name:
    type: string
    description: Domain for AWS Route53
    required: true
    default: exampleapp.oscbpoc.co

  openshift_cluster:
    type: dict
    description: Openshift networking config
    required: true
    constraints:
      - valid_values:
          - api_config:
              host: { get_secret: openshift_master_endpoint }
              api_key: { get_secret: openshift_secret_token }
              debug: false
              verify_ssl: false
            network_config:
              cluster_name: os-cb-cluster1
              vpc: vpc-01f23fec9019e8f4c
              public_subnet: subnet-003311ac114cc7dba
              route_tb: rtb-0c5ee5b09eda70143
              security_group: sg-090d730343326f2cf
              instances:
              # masters:
                - i-099b43bec984ab7e5
                - i-0463df568c1aa7e66
                - i-0d62c1d224156e85d
              # workers:
                - i-09f1d2de035025d02
                - i-021811b728f181fc5
              # infra:
                - i-09a56aaf3f1e4ff13
                - i-0018d3b701eeeb140
          - api_config:
              host: { get_secret: openshift2_master_endpoint }
              api_key: { get_secret: openshift2_secret_token }
              debug: false
              verify_ssl: false
            network_config:
              cluster_name: os-cb-cluster2
              vpc: vpc-0ec3c7bcafea43a99
              public_subnet: subnet-013004ef27a8bd393
              route_tb: rtb-088df2c51e2082310
              security_group: sg-0fc8ddf0d72e610e8
              instances:
              # masters:
                - i-041fe1bc3ac69fa80
                - i-0cf10177163a4529f
                - i-0a874e009daf126af
              # workers:
                - i-03d854125d6b7fd65
                - i-0e79cc215ccac1239
              # infra:
                - i-0a53aef8171a6e301
                - i-0dbc9810689968bb4


node_templates:
  terraform:
    type: cloudify.nodes.terraform
    properties:
      resource_config:
        installation_source: https://releases.hashicorp.com/terraform/0.14.3/terraform_0.14.3_linux_amd64.zip

  terraform_module:
    type: cloudify.nodes.terraform.Module
    properties:
      resource_config:
        variables:
          aws_region: { get_input: aws_region }
          access_key: { get_secret: aws_access_key }
          secret_key: { get_secret: aws_secret_key }
          availability_zones: { get_input: availability_zones }
          elb_name: { get_input: elb_name }
          db_name: { get_input: db_name }
          db_username: { get_input: db_username }
          db_password: { get_input: db_password }
          domain_name: { get_input: domain_name }
          openshift_vpc_id: { get_input: [openshift_cluster, network_config, vpc] }
          openshift_route_tb_id: { get_input: [openshift_cluster, network_config, route_tb] }
          openshift_public_subnet_id: { get_input: [openshift_cluster, network_config, public_subnet] }
          openshift_security_group_id: { get_input: [openshift_cluster, network_config, security_group] }
          openshift_instances: { get_input: [openshift_cluster, network_config, instances] }
        source:
          location: https://github.com/Cloudify-PS/citi-poc-tf/archive/refs/heads/rds_dev.zip
          username: { get_secret: github_username }
          password: { get_secret: github_password }
    relationships:
      - target: terraform
        type: cloudify.terraform.relationships.run_on_host

capabilities:

  db_endpoint:
    description: RDS endpoint
    value: { get_attribute: [terraform_module, resources, main_db_rds, instances, 0, attributes, address] }

  lb_endpoint:
    description: ELB endpoint
    value: { get_attribute: [terraform_module, resources, main_lb, instances, 0, attributes, dns_name] }
