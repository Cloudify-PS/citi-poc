tosca_definitions_version: cloudify_dsl_1_3


imports:
  - https://cloudify.co/spec/cloudify/5.1.0/types.yaml
  - CLUSTER_A--application-rds.yaml
  - CLUSTER_B--application-rds.yaml


inputs:

  lb_name:
    type: string
    default: CloudifyLB

  domain_name:
    type: string
    description: Domain for AWS Route53
    required: true
    default: "*.cloudifydemo.link"


node_templates:

  terraform:
    type: cloudify.nodes.terraform
    properties:
      resource_config:
        installation_source: https://releases.hashicorp.com/terraform/0.14.3/terraform_0.14.3_linux_amd64.zip

  terraform_module:
    type: cloudify.nodes.terraform.Module
    properties:
      resource_config:
        variables:
          aws_region: { get_input: CLUSTER_A--RDS--aws_region }
          access_key: { get_secret: aws_access_key }
          secret_key: { get_secret: aws_secret_key }
          lb_name: { get_input: lb_name }
          domain_name: { get_input: domain_name }
          vpc_id: { get_attribute: [CLUSTER_A--RDS--openshift_cluster, network_config, vpc] }
          public_subnet_id: { get_attribute: [CLUSTER_A--RDS--openshift_cluster, network_config, public_subnet] }
          cluster_a:
            - ip: "10.0.200.0"
              http_port: "31763"
              https_port: "30490"
              availability_zone: eu-central-1a
            - ip: "10.0.136.223"
              http_port: "31763"
              https_port: "30490"
              availability_zone: eu-central-1a
          cluster_b:
            - ip: "10.100.189.183"
              http_port: "31516"
              https_port: "31010"
              availability_zone: all
            - ip: "10.100.236.78"
              http_port: "31516"
              https_port: "31010"
              availability_zone: all
        source:
          location: https://github.com/Cloudify-PS/citi-poc-tf/archive/refs/heads/lb.zip
          username: { get_secret: github_username }
          password: { get_secret: github_password }
    relationships:
      - target: CLUSTER_A--RDS--openshift_cluster
        type: cloudify.relationships.depends_on
      - target: CLUSTER_B--RDS--openshift_cluster
        type: cloudify.relationships.depends_on
      - target: CLUSTER_A--RDS--terraform
        type: cloudify.terraform.relationships.run_on_host


capabilities:

  app_url:
    value: { get_input: domain_name }